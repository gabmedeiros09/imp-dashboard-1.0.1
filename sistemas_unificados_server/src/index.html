<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Manrope">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Impressoras (GILOG)</title>
    <meta http-equiv="refresh" content="600">
    <link rel="shortcut icon" href="src/logo_gov.ico" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            padding-bottom: 70px;
            background-image: url("/src/ELEMENTO.PNG");
            background-repeat: no-repeat;
            background-position: left;
            background-size: 40%;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            flex-grow: 1;
        }

        header .logo-left {
            width: 140px;
        }

        header .logo-right {
            width: 100px;
        }

        .dropdown {
              
            position: relative;
            display: inline-block;
            padding-right: 100px;
        }

        .dropdown-btn {
            white-space: nowrap;
            text-overflow: ellipsis; 
            background-color: transparent;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-left: 25px;
        }

        .title-menu {
            font-family: 'Manrope', serif;
            font-size: 1.4em;
        }

        .dropdown-btn i {
            
            margin-left: 5px;
            font-size: 0.8em;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f4f4f4;
            width: 135px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 1;
            border-radius: 6px;
           left: 0;
            top: 90%;

        }

        .dropdown-content a {
            color: #000;
            font-size: 1.0rem;
            font-family: 'Manrope', serif;
            font-weight: 550;
            border-radius: 6px;
            padding: 15px 10px;
            text-decoration: none;
            display: block;
            box-sizing: border-box;
            width: 100%;
        }

        .dropdown-content a:hover {
            background-color: #0D57A1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 23px;
            gap: 5px;
        }

        .container a {
            text-decoration: none;
            color: inherit;
        }

        .container .number_series {
            display: flex;
            font-family: 'Manrope', serif;      
            font-weight: 800;
            font-size: 11px;
            justify-content: center;
            align-items: center;
            padding: 0 0 0 20px;          
            margin: -0.4rem 0 0 0;         
            float: inline-start;
            text-align: center;
            color: rgb(72, 156, 252);
        }

        .button {
            background-color: #033c6bd7;
            color: white;
            font-weight: bold;
            border: none;
            padding: 20px 20px 10px 20px;
            margin: 10px;
            text-align: center;
            font-size: 22px;
            width: 320px;
            height: 270px;
            cursor: pointer;
            border-radius: 7px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            justify-content: flex-start;
        }

        .button:hover {
            background-color: #003bddb7;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .button.offline {
            background-color: #333;
            cursor: not-allowed;
        }

        .button-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 0 0 5px 0;
            align-items: center;
        }

        .printer-number {
            font-size: 14px;
            margin: 0;
            font-style: italic;
        }

        .printer-status {
            font-size: 13px; 
            color: white; 
            margin-top: 0px; 
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .title {
            font-family: 'Manrope', serif;
            margin: 5px 0;
            font-size: 22px;
        }

        .ip {
            font-size: 14px;
            font-family: 'Manrope', serif;
            margin-bottom: 10px;
            display: block;
        }

        .toner-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 97.7%;
            position: absolute;
            bottom: 0px;
            left: 1.3%;
            gap: 5px;
            justify-content: flex-end;
        }

        .toner-colors {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 5px;
        }

        .toner-color {
            width: 40px;
            height: 40px;
            border-radius: 20px;
        }

        .toner-percentages {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .toner {
            padding: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            width: 100%;
        }

        .info-color {
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            text-align: center;
        }

        .toner-color.black {
            background-color: black;
            border: 1px solid #333;
        }

        .toner-color.cyan {
            background-color: cyan;
            border: 1px solid #00a2a2;
        }

        .toner-color.magenta {
            background-color: magenta;
            border: 1px solid #a200a2;
        }

        .toner-color.yellow {
            background-color: yellow;
            border: 1px solid #a2a200;
        }

        .toner.high {
            background-color: rgb(32, 136, 6);
            font-weight: bold;
            font-size: 23px;
            border-radius: 0 0 8px 8px;
        }

        .toner.medium {
            background-color: rgb(247, 174, 38);
            font-weight: bold;
            font-size: 23px;
            border-radius: 0 0 8px 8px;
        }

        .toner.low {
            background-color: #df1a1ada;
            font-weight: bold;
            font-size: 23px;
            border-radius: 0 0 8px 8px;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .divider {
            display: block;
            width: 100%;
            height: 5px;
            left: 0;
            margin: 0.1px 0.5px;
        }

        /* Modal styles atualizados */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #f8f9fa;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 85%;
            max-width: 700px;
            font-family: 'Manrope', sans-serif;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            border: 1px solid #e0e0e0;
        }

        .modal-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        
.drum-progress {
    margin-top: 5px;
    margin-bottom: 20px;
}

.drum-progress-container {
    width: 100%;
    background-color: #e0e0e0;
    border-radius: 5px;
    height: 20px;
}

.drum-progress-bar {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s;
}

.drum-progress-high {
    background-color: #4CAF50; /* Verde */
}

.drum-progress-medium {
    background-color: #FFC107; /* Amarelo */
}

.drum-progress-low {
    background-color: #F44336; /* Vermelho */
}

        .close-button {
            color: #7f8c8d;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #34495e;
        }

        .modal-body {
            color: #34495e;
            line-height: 1.6;
        }

        .info-row {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }

        .info-label {
            font-weight: 600;
            width: 120px;
            color: #2c3e50;
        }

        .info-value {
            flex: 1;
        }

        .web-service-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .web-service-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .error-section {
            background-color: #fef5f5;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 25px;
            display: none;
            animation: fadeIn 0.5s;
        }

        .error-section.visible {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .error-title {
            color: #e74c3c;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-icon {
            font-size: 20px;
        }

        .error-item {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 2px solid #f1c40f;
        }

        .error-item:last-child {
            margin-bottom: 0;
        }

        .status-indicator-modal {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-online {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-warning {
            background-color: #fff8e1;
            color: #f57f17;
        }

        .status-offline {
            background-color: #ffebee;
            color: #c62828;
        }

        .status-unknown {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .toner-display {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .toner-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        .toner-color-modal {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-bottom: 5px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toner-value-modal {
            font-weight: 600;
            font-size: 16px;
        }

        .toner-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            .button {
                width: 160px;
                height: 90px;
                font-size: 16px;
            }
            .toner-color {
                width: 25px;
                height: 25px;
            }
            .toner {
                font-size: 10px;
            }
            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .button {
                width: 140px;
                height: 80px;
                font-size: 14px;
            }
            header {
                flex-direction: column;
                padding: 10px;
            }
            header .logo-left,
            header .logo-right {
                width: 80px;
            }
            header h1 {
                font-size: 1.2rem;
                margin: 10px 0;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .info-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .info-label {
                width: auto;
                margin-bottom: 5px;
            }
        }
    </style>
</head>

<body>
    <header>
        <img src="/src/LOGO_GOV.png" alt="Logo Governo" class="logo-left">
        <h1>Gerenciador de Impressoras (SEPROR)</h1>
        <nav class="dropdown">
            <button class="dropdown-btn">
                <span class="title-menu">
                    Menu <i class="fas fa-chevron-down"></i>
                </span>
            </button>
            <div class="dropdown-content">
                <a href="/config" target="_blank"
                   >Configura√ß√µes</a>
                <a href="/cadastro-impressoras" target="_blank"
                    >Cadastrar Impressoras</a>
                     <a href="/oid" target="_blank"
                    >Configurar Oids</a>

            </div>
        </nav>
        <img src="src/LOGO_SEPROR.png" alt="Logo SEPROR" class="logo-right">
    </header>

    <div class="container">
        <!-- Os bot√µes das impressoras ser√£o gerados dinamicamente pelo JavaScript -->
    </div>
   
    <footer>
        <img src="src/LINHA.PNG" alt="Linha divis√≥ria" class="divider">
        <p>&copy; 2025 - Secret√°ria de Estado de Produ√ß√£o Rural - SEPROR. Desenvolvido por Renato Pedrozo (GILOG) em colabora√ß√£o com Ingrid Gabrielly</p>
    </footer>

    <!-- Modal -->
    <div id="printerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Detalhes da Impressora</h2>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <p>Carregando informa√ß√µes...</p>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes iniciais
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        // Vari√°vel para armazenar a URL base da API
        let apiBaseUrl = '';
        
        // Dados das impressoras
        const PRINTERS = {
            "10.46.6.1": "IMP_GAB",
            "10.46.6.2": "IMP_GAB_COLOR",
            "10.46.6.3": "IMP_GSE",
            "10.46.6.4": "IMP_GSE_COLOR",
            "10.46.6.5": "IMP_DAF",
            "10.46.6.6": "IMP_ASSJUR",
            "10.46.6.7": "IMP_CORREDOR_DARF",
            "10.46.6.8": "IMP_CORREDOR_RH",
            "10.46.6.9": "IMP_CORREDOR_GAB",
            "10.46.6.10": "IMP_PROTOCOLO",
            "10.46.6.11": "GILOG",
            "10.46.6.12": "IMP_PCODEPA",
            "10.46.6.13": "IMP_UCI",
            "10.46.6.15": "IMP_GAB_SEPA"
        };

        const COLOR_PRINTERS = ["10.46.6.2", "10.46.6.4"];
        let impressoras = [];

        // Vari√°vel para controlar se o bip j√° foi tocado para evitar repeti√ß√£o
let paperJamBeepPlayed = false;

/**
 * Fun√ß√£o para tocar bip quando h√° obstru√ß√£o de papel
 */
function playPaperJamBeep() {
    try {
        // Criar contexto de √°udio
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        // Configurar o oscilador para um tom de alerta
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // Frequ√™ncia em Hz
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
        
        // Configurar ganho (volume)
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        // Conectar os n√≥s
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Tocar o som
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
        
        console.log('üîä Bip de obstru√ß√£o de papel tocado');
        paperJamBeepPlayed = true;
        
    } catch (error) {
        console.error('Erro ao tocar bip:', error);
        // Fallback: usar API de √°udio mais simples
        fallbackBeep();
    }
}

/**
 * Fallback para navegadores mais antigos
 */
function fallbackBeep() {
    try {
        // Tentar usar o elemento de √°udio
        const beepSound = new Audio("data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADAAAGAAAPeEMAADAb/4gAAIACQhgIYCDADAIYODCD/4uAACCBMAgDgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAOAgwA4CDADgIMAAA=");
        beepSound.volume = 0.3;
        beepSound.play().catch(e => console.log('√Åudio bloqueado pelo navegador:', e));
    } catch (error) {
        console.error('Fallback beep tamb√©m falhou:', error);
    }
}

/**
 * Verificar e tocar bip para obstru√ß√£o de papel
 */
function checkAndPlayPaperJamBeep(status, ip) {
    const buttonElement = document.getElementById(`button-${ip}`);
    
    if (status && status.includes('Obstru√ß√£o de papel')) {
        // Adicionar classe visual
        buttonElement.classList.add('paper-jam');
        
        if (!paperJamBeepPlayed) {
            console.log(`üö® Obstu√ß√£o de papel detectada na impressora ${ip}`);
            playPaperJamBeep();
            showPaperJamNotification(ip);
        }
    } else {
        // Remover classe visual e resetar flag
        buttonElement.classList.remove('paper-jam');
        paperJamBeepPlayed = false;
    }
}

/**
 * Mostrar notifica√ß√£o visual de obstru√ß√£o de papel
 */
function showPaperJamNotification(ip) {
    // Verificar se o navegador suporta notifica√ß√µes
    if ("Notification" in window) {
        if (Notification.permission === "granted") {
            new Notification("üö® Obstu√ß√£o de Papel Detectada", {
                body: `A impressora ${ip} est√° com obstru√ß√£o de papel`,
                icon: "/src/logo_gov.ico",
                tag: "paper-jam-alert"
            });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification("üö® Obstu√ß√£o de Papel Detectada", {
                        body: `A impressora ${ip} est√° com obstru√ß√£o de papel`,
                        icon: "/src/logo_gov.ico",
                        tag: "paper-jam-alert"
                    });
                }
            });
        }
    }
    
    // Tamb√©m mostrar alerta no console
    console.warn(`‚ö†Ô∏è ALERTA: Obstu√ß√£o de papel na impressora ${ip}`);
}

        /**
         * Carrega as configura√ß√µes do servidor
         */
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Erro ao carregar configura√ß√µes');
                
                const config = await response.json();
                apiBaseUrl = `http://${config.host}:${config.port}`;
                return true;
            } catch (error) {
                console.error('Usando configura√ß√£o padr√£o:', error);
                apiBaseUrl = 'http://localhost:3000'; // Fallback
                return false;
            }
        }

        /**
         * Carrega as impressoras do servidor ou usa fallback
         */
        async function loadPrinters() {
            // Primeiro carrega as configura√ß√µes
            await loadConfig();
            
            try {
                const response = await fetch(`${apiBaseUrl}/impressoras`);
                if (!response.ok) throw new Error('Erro ao carregar impressoras');
                
                impressoras = await response.json();
                sortPrinters();
                createPrinterButtons();
                updateAllTonerStatus();
            } catch (error) {
                console.error('Usando impressoras fallback:', error);
                useFallbackPrinters();
            }
        }

        /**
         * Ordena impressoras por endere√ßo IP
         */
        function sortPrinters() {
            impressoras.sort((a, b) => {
                const lastA = parseInt(a.ip.split('.').pop());
                const lastB = parseInt(b.ip.split('.').pop());
                return lastA - lastB;
            });
        }

        /**
         * Usa configura√ß√£o fallback quando o servidor n√£o est√° dispon√≠vel
         */
        function useFallbackPrinters() {
            impressoras = Object.keys(PRINTERS).map(ip => ({
                ip,
                nome: PRINTERS[ip],
                colorida: COLOR_PRINTERS.includes(ip)
            }));
            sortPrinters();
            createPrinterButtons();
            updateAllTonerStatus();
        }

        /**
         * Cria os bot√µes das impressoras dinamicamente
         */
        function createPrinterButtons() {
            const container = document.querySelector('.container');
            container.innerHTML = '';

            impressoras.forEach((impressora) => {
                const buttonHtml = `
                    <a href="#" onclick="openModal('${impressora.ip}', '${impressora.nome}', event)">
                        <button class="button" id="button-${impressora.ip}">
                            <div class="button-header">
                                <span class="printer-number" id="counter-${impressora.ip}">Contador: ...</span>
                                <div class="status-indicator">
                                    <div class="led" id="led-${impressora.ip}"></div>
                                    <div class="printer-status" id="printer-status-${impressora.ip}">Aguardando...</div>
                                </div>
                            </div>
                            </br></br>    
                            <div class="title">${impressora.nome}</div>
                            <span class="ip">(${impressora.ip})</span>
                           
                            ${getTonerHTML(impressora)}
                        </button>
                        <span class="number_series" id="number-series-${impressora.ip}"> N¬∞ S√©rie:... </span>
                    </a>
                `;
                container.insertAdjacentHTML('beforeend', buttonHtml);
            });
        }

        /**
         * Retorna o HTML apropriado para o display de toner
         */
        function getTonerHTML(impressora) {
            if (impressora.colorida) {
                return `
                    <span class="info-color">
                        <div class="toner-colors">
                            <div class="toner-color cyan"></div>
                            <div class="toner-color magenta"></div>
                            <div class="toner-color yellow"></div>
                            <div class="toner-color black"></div>
                        </div>
                        <div class="toner-percentages">
                            <span class="toner" id="toner-${impressora.ip}-black">%</span>
                            <span class="toner" id="toner-${impressora.ip}-cyan">%</span>
                            <span class="toner" id="toner-${impressora.ip}-magenta">%</span>
                            <span class="toner" id="toner-${impressora.ip}-yellow">%</span>
                        </div>
                    </span>
                `;
            } else {
                return `
                    <div class="toner-wrapper">
                        <span class="toner" id="toner-${impressora.ip}">%</span>
                    </div>
                `;
            }
        }

        /**
         * Atualiza o status do toner para uma impressora espec√≠fica
         */
        async function updateTonerStatus(ip) {
            try {
                const response = await fetch(`${apiBaseUrl}/toner/${ip}`);
                if (!response.ok) throw new Error('Impressora n√£o respondeu');

                const data = await response.json();
                const impressora = impressoras.find(i => i.ip === ip);
                if (!impressora) return;

                updatePrinterUI(ip, data, impressora);
            } catch (error) {
                handlePrinterError(ip);
            }
        }

        /**
         * Atualiza a interface do usu√°rio para uma impressora online
         */
        function updatePrinterUI(ip, data, impressora) {
    const buttonElement = document.getElementById(`button-${ip}`);
    const statusElement = document.getElementById(`printer-status-${ip}`);

    buttonElement.classList.remove('offline');

        // ‚úÖ ADICIONAR: Armazenar √∫ltimo status
    buttonElement.dataset.lastStatus = data.status || 'Desconhecido';
    
    // ‚úÖ ADICIONAR ESTA LINHA - Verificar e tocar bip para obstru√ß√£o de papel
    checkAndPlayPaperJamBeep(data.status, ip);
    
    updatePrinterStatus(ip, data.status || 'Desconhecido');

    if (statusElement) {
        statusElement.textContent = data.status || 'Desconhecido';
        statusElement.style.color = getStatusColor(data.status);
    }

            if (impressora.colorida) {
                updateColorTonerLevels(ip, data.toner || [0, 0, 0, 0]);
            } else {
                updateMonoTonerLevel(ip, data.toner ? data.toner[0] || 0 : 0);
            }

            const counterElement = document.getElementById(`counter-${ip}`);
            if (counterElement) {
                counterElement.textContent = data.counter !== null 
                    ? `Contador: ${data.counter}` 
                    : 'Contador: N/A';
            }

            const serialElement = document.getElementById(`number-series-${ip}`);
            if (serialElement) {
                serialElement.textContent = data.serial ? `N¬∞ S√©rie: ${data.serial}` : 'N¬∞ S√©rie: N/A';
            }

            buttonElement.dataset.errorDetails = data.errorDetails ? JSON.stringify(data.errorDetails) : '[]';
        }

        /**
         * Retorna a cor apropriada para o status da impressora
         */
        function getStatusColor(status) {
            const statusColors = {
                'Imprimindo': 'white',
                'Em Descanso': 'white',
                'Aquecendo': 'white',
                'Sem papel': 'white',
                'Obstru√ß√£o de papel': 'white',
                'Sem toner': 'white',
                'Erro desconhecido': 'white'
            };
            return statusColors[status] || 'white';
        }

        /**
         * Atualiza os n√≠veis de toner para impressoras coloridas
         */
        function updateColorTonerLevels(ip, tonerLevels) {
            ['black', 'cyan', 'magenta', 'yellow'].forEach((color, index) => {
                const tonerElement = document.getElementById(`toner-${ip}-${color}`);
                const percentage = tonerLevels[index] || 0;
                tonerElement.textContent = `${percentage}%`;
                updateTonerColorClass(tonerElement, percentage);
            });
        }

        /**
         * Atualiza o n√≠vel de toner para impressoras monocrom√°ticas
         */
        function updateMonoTonerLevel(ip, percentage) {
            const tonerElement = document.getElementById(`toner-${ip}`);
            tonerElement.textContent = `${percentage}%`;
            updateTonerColorClass(tonerElement, percentage);
        }

        /**
         * Manipula erros de comunica√ß√£o com a impressora
         */
        function handlePrinterError(ip) {
            const buttonElement = document.getElementById(`button-${ip}`);
            const statusElement = document.getElementById(`printer-status-${ip}`);
            const impressora = impressoras.find(i => i.ip === ip);
            if (!impressora) return;

            if (statusElement) {
                statusElement.textContent = 'Offline';
                statusElement.style.color = '#ccc';
            }

            buttonElement.classList.add('offline');
            updatePrinterStatus(ip, 'offline');

            if (impressora.colorida) {
                ['black', 'cyan', 'magenta', 'yellow'].forEach(color => {
                    const tonerElement = document.getElementById(`toner-${ip}-${color}`);
                    if (tonerElement) {
                        tonerElement.textContent = 'OFF';
                        tonerElement.classList.remove('high', 'medium', 'low');
                    }
                });
            } else {
                const tonerElement = document.getElementById(`toner-${ip}`);
                if (tonerElement) {
                    tonerElement.textContent = 'OFF';
                    tonerElement.classList.remove('high', 'medium', 'low');
                }
            }
        }

        /**
         * Atualiza o status visual do LED da impressora
         */
        function updatePrinterStatus(ip, status) {
            const ledElement = document.getElementById(`led-${ip}`);
            if (!ledElement) return;

            ledElement.classList.remove('online', 'warning', 'offline', 'error');
            
            const statusColors = {
                'Imprimindo': '#70FF24',
                'Em Descanso': '#7eddfc',
                'Aquecendo': '#FF8307',
                'Sem papel': '#FF0202',
                'Obstru√ß√£o de papel': '#FF0202',
                'Sem toner': '#FF0202',
                'Erro desconhecido': '#FF0202',
                'offline': '#cccccc'
            };

            ledElement.style.backgroundColor = statusColors[status] || '#999';
        }

        /**
         * Atualiza a classe de cor do toner com base no percentual
         */
        function updateTonerColorClass(element, percentage) {
            element.classList.remove('high', 'medium', 'low');
            
            if (percentage > 50) {
                element.classList.add('high');
            } else if (percentage >= 30) {
                element.classList.add('medium');
            } else {
                element.classList.add('low');
            }
        }

        /**
         * Atualiza todos os status de toner
         */
        function updateAllTonerStatus() {
            impressoras.forEach(impressora => {
                updateTonerStatus(impressora.ip);
            });
        }

        /**
         * Abre o modal com informa√ß√µes da impressora
         */
        function openModal(ip, nome, event) {
            event.preventDefault();
            const modal = document.getElementById('printerModal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const buttonElement = document.getElementById(`button-${ip}`);

            modal.style.display = 'block';
            modalTitle.textContent = nome;

            const statusElement = document.getElementById(`printer-status-${ip}`);
            const counterElement = document.getElementById(`counter-${ip}`);
            const serialElement = document.getElementById(`number-series-${ip}`);
            const ledElement = document.getElementById(`led-${ip}`);
            
            const statusText = statusElement ? statusElement.textContent : 'Desconhecido';
            const statusColor = ledElement ? window.getComputedStyle(ledElement).backgroundColor : '#999';
            
            let errorDetails = [];
            try {
                if (buttonElement.dataset.errorDetails) {
                    errorDetails = JSON.parse(buttonElement.dataset.errorDetails);
                }
            } catch (e) {
                console.error('Erro ao analisar detalhes de erro:', e);
            }

            const validErrors = errorDetails.filter(error => 
                error && error !== "N/A" && error !== "Nenhum erro" && error !== ""
            );

            const tonerLevels = {
                black: document.getElementById(`toner-${ip}-black`)?.textContent || 'N/A',
                cyan: document.getElementById(`toner-${ip}-cyan`)?.textContent || 'N/A',
                magenta: document.getElementById(`toner-${ip}-magenta`)?.textContent || 'N/A',
                yellow: document.getElementById(`toner-${ip}-yellow`)?.textContent || 'N/A'
            };

            let statusClass = 'status-unknown';
            if (statusText.includes('Offline')) {
                statusClass = 'status-offline';
            } else if (statusText.includes('Erro') || statusText.includes('Sem') || statusText.includes('Obstru√ß√£o')) {
                statusClass = 'status-warning';
            } else if (statusText.includes('Imprimindo') || statusText.includes('Descanso') || statusText.includes('Aquecendo')) {
                statusClass = 'status-online';
            }

            // Buscar dados do tambor via API
            fetch(`${apiBaseUrl}/toner/${ip}`)
                .then(response => response.json())
                .then(data => {
                    modalBody.innerHTML = `
                        <div class="modal-body">
                            <div class="info-row">
                                <span class="info-label">Endere√ßo IP:</span>
                                <span class="info-value">${ip} 
                                    <a href="http://${ip}/sws/index.html" target="_blank" class="web-service-link">
                                        <span>Acessar Web Service</span>
                                    </a>
                                </span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Status:</span>
                                <span class="info-value">
                                    <span class="status-indicator-modal ${statusClass}" style="background-color: ${statusColor}20; color: ${statusColor}">
                                        <span>${statusText}</span>
                                    </span>
                                </span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Contador:</span>
                                <span class="info-value">${counterElement ? counterElement.textContent.replace('Contador: ', '') : 'N/A'}</span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">N¬∫ S√©rie:</span>
                                <span class="info-value">${serialElement ? serialElement.textContent.replace('N¬∞ S√©rie: ', '') : 'N/A'}</span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Vida do Tambor:</span>
                                <span class="info-value">
                                    ${data.drum && data.drum.current && data.drum.max ? 
                                        `${data.drum.current} restantes de ${data.drum.max} p√°ginas (${data.drum.percent}%)` : 
                                        'Dados n√£o dispon√≠veis'}
                                </span>
                            </div>
                            
                            ${data.drum && data.drum.percent ? `
                            <div style="margin-top: 5px; margin-bottom: 20px;">
                                <div style="width: 100%; background-color: #e0e0e0; border-radius: 5px;">
                                    <div style="width: ${data.drum.percent}%; height: 20px; background-color: ${
                                        data.drum.percent > 70 ? '#4CAF50' : 
                                        data.drum.percent > 30 ? '#FFC107' : '#F44336'
                                    }; border-radius: 5px; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            ` : ''}
                            
                           
                            
                            <div class="error-section ${validErrors.length > 0 ? 'visible' : ''}">
                                <h3 class="error-title">
                                    <span class="error-icon">‚ö†Ô∏è</span>
                                    <span>Detalhes de Erro</span>
                                </h3>
                                ${validErrors.map((error, index) => `
                                    <div class="error-item">
                                        <strong>Erro ${index + 1}:</strong> ${error}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Erro ao buscar dados do tambor:', error);
                    modalBody.innerHTML = `
                        <div class="modal-body">
                            <div class="info-row">
                                <span class="info-label">Endere√ßo IP:</span>
                                <span class="info-value">${ip} 
                                    <a href="http://${ip}/sws/index.html" target="_blank" class="web-service-link">
                                        <span>Acessar Web Service</span>
                                    </a>
                                </span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Status:</span>
                                <span class="info-value">
                                    <span class="status-indicator-modal ${statusClass}" style="background-color: ${statusColor}20; color: ${statusColor}">
                                        <span>${statusText}</span>
                                    </span>
                                </span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Contador:</span>
                                <span class="info-value">${counterElement ? counterElement.textContent.replace('Contador: ', '') : 'N/A'}</span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">N¬∫ S√©rie:</span>
                                <span class="info-value">${serialElement ? serialElement.textContent.replace('N¬∞ S√©rie: ', '') : 'N/A'}</span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">Vida do Tambor:</span>
                                <span class="info-value">Dados n√£o dispon√≠veis</span>
                            </div>
                            
                            ${getTonerModalHTML(tonerLevels, statusText.includes('Offline'))}
                            
                            <div class="error-section ${validErrors.length > 0 ? 'visible' : ''}">
                                <h3 class="error-title">
                                    <span class="error-icon">‚ö†Ô∏è</span>
                                    <span>Detalhes de Erro</span>
                                </h3>
                                ${validErrors.map((error, index) => `
                                    <div class="error-item">
                                        <strong>Erro ${index + 1}:</strong> ${error}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
        }

        function getTonerModalHTML(tonerLevels, isOffline) {
            if (isOffline) {
                return `
                    <div class="info-row">
                        <span class="info-label">Toner:</span>
                        <span class="info-value">Impressora offline</span>
                    </div>
                `;
            }

            const isColor = tonerLevels.cyan !== 'N/A' && tonerLevels.magenta !== 'N/A' && tonerLevels.yellow !== 'N/A';

            if (!isColor) {
                return `
                    <div class="info-row">
                        <span class="info-label">Toner:</span>
                        <span class="info-value">${tonerLevels.black}</span>
                    </div>
                `;
            }

            return `
                <div class="info-row">
                    <span class="info-label">Toner:</span>
                    <span class="info-value">
                        <div class="toner-display">
                            <div class="toner-item">
                                <div class="toner-color-modal" style="background-color: cyan; border-color: #00a2a2;"></div>
                                <span class="toner-value-modal">${tonerLevels.cyan}</span>
                                <span class="toner-label">Ciano</span>
                            </div>
                            <div class="toner-item">
                                <div class="toner-color-modal" style="background-color: magenta; border-color: #a200a2;"></div>
                                <span class="toner-value-modal">${tonerLevels.magenta}</span>
                                <span class="toner-label">Magenta</span>
                            </div>
                            <div class="toner-item">
                                <div class="toner-color-modal" style="background-color: yellow; border-color: #a2a200;"></div>
                                <span class="toner-value-modal">${tonerLevels.yellow}</span>
                                <span class="toner-label">Amarelo</span>
                            </div>
                            <div class="toner-item">
                                <div class="toner-color-modal" style="background-color: black; border-color: #333;"></div>
                                <span class="toner-value-modal">${tonerLevels.black}</span>
                                <span class="toner-label">Preto</span>
                            </div>
                        </div>
                    </span>
                </div>
            `;
        }

        /**
         * Fecha o modal
         */
        function closeModal() {
            document.getElementById('printerModal').style.display = 'none';
        }

        // Fechar o modal clicando fora do conte√∫do
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('printerModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            loadPrinters();
            setInterval(updateAllTonerStatus, 10000);
        });
    </script>
</body>
</html>